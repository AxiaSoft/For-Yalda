<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‡Ø¯ÛŒÙ‡ ÛŒÙ„Ø¯Ø§ÛŒ Ø´Ù…Ø§</title>

  <style>
    @font-face {
      font-family: 'Kalameh';
      src: url('assets/font/Kalameh-Black.ttf') format('truetype');
      font-display: swap;
    }
    @font-face {
      font-family: 'IranNastaliq';
      src: url('assets/font/IranNastaliq.ttf') format('truetype');
      font-display: swap;
    }

    :root {
      --color-primary: #e53935;
      --color-text: #f7f7f7;
      --color-muted: #cfd8dc;
      --card-bg: rgba(0,0,0,0.6);
      --radius: 20px;
      --shadow-card: 0 10px 26px rgba(0,0,0,0.32);
      --text-shadow: 0 2px 6px rgba(0,0,0,0.4);
      --track-bg: rgba(255,255,255,0.16);
      --track-fill: #e53935;
      --ease: 0.6s ease;
    }

    @media (prefers-reduced-motion: reduce) { :root { --ease: 0s; } }

    body {
      margin: 0;
      font-family: 'Kalameh', system-ui, -apple-system, Segoe UI, Roboto, 'Vazirmatn', sans-serif;
      color: var(--color-text);
      background: url('assets/img/background.png') center center / cover no-repeat fixed;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .hero {
      text-align: center;
      font-size: clamp(2.6rem, 9vw, 5rem);
      font-weight: 900;
      color: var(--color-primary);
      margin: 26px 0 8px;
      text-shadow: -6px 6px 4px rgba(0, 0, 0, 0.75);
    }

    .wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 16px 32px;
      flex: 1;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 22px;
      backdrop-filter: blur(12px) saturate(160%);
      -webkit-backdrop-filter: blur(12px) saturate(160%);
      box-shadow: var(--shadow-card);
      margin-bottom: 32px;
    }

    /* Fortune */
    .fortune { text-align: center; overflow: hidden; max-height: 120px; transition: max-height var(--ease), padding 0.3s ease; }
    .fortune.expanded { max-height: 650px; }
    .fortune h2 { margin: 0 0 8px; font-size: 1.25rem; text-shadow: var(--text-shadow); }
    .fortune p.helper { margin: 0 0 12px; color: var(--color-muted); font-size: .95rem; text-shadow: var(--text-shadow); }

    .btn-nit,
    .btn {
      border: none; cursor: pointer; padding: 10px 16px; border-radius: 14px; color: #fff; font-weight: 800; letter-spacing: 0.3px;
      background: linear-gradient(135deg, rgba(229,57,53,0.6), rgba(67,160,71,0.6));
      box-shadow: 0 8px 22px rgba(0,0,0,0.35), 0 0 14px rgba(229,57,53,0.28), 0 0 16px rgba(67,160,71,0.24);
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
      text-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .btn-nit:hover, .btn:hover { transform: translateY(-2px); }
    .btn-nit:focus-visible, .btn:focus-visible { outline: 2px solid #fff; outline-offset: 3px; }

    /* Poem layout */
    .poem {
      font-family: 'IranNastaliq', serif; font-size: clamp(2rem, 6vw, 3.2rem); line-height: 2.1; margin: 14px 0 10px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.4); opacity: 0; transition: opacity var(--ease); display: flex; flex-direction: column; align-items: center;
    }
    .misra { margin: 2px 0; width: 100%; }
    .misra-top, .misra-bottom { text-align: center; }
    @media (max-width: 768px) { .misra-top { text-align: right; margin-right: 8%; } .misra-bottom { text-align: left; margin-left: 8%; } }

    .meaning {
      font-size: 1.05rem; color: var(--color-muted); text-align: center; border-top: 1px dashed rgba(255,255,255,0.26);
      padding-top: 10px; text-shadow: 0 2px 6px rgba(0,0,0,0.4); opacity: 0; transition: opacity var(--ease);
    }
    .fortune.expanded .poem, .fortune.expanded .meaning { opacity: 1; }

    /* Players */
    .message h2, .music h2 { margin: 0 0 12px; text-align: center; font-size: 1.2rem; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }
    .message p, .music p { text-align: center; color: var(--color-muted); margin: 4px 0 16px; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }

    .player {
      display: grid; grid-template-columns: auto 1fr auto; grid-template-rows: auto auto; gap: 10px 12px; align-items: center;
    }
    .timeline {
      grid-column: 2 / 3; grid-row: 1 / 2; position: relative; height: 8px; border-radius: 999px; background: var(--track-bg);
      overflow: hidden; cursor: pointer;
    }
    .progress {
      position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: var(--track-fill); box-shadow: 0 0 12px rgba(229,57,53,0.75);
      will-change: width;
    }
    .time { grid-column: 1 / 2; grid-row: 2 / 3; font-size: .95rem; color: var(--color-muted); text-shadow: 0 2px 6px rgba(0,0,0,0.4); justify-self: start; }
    .duration { grid-column: 3 / 4; grid-row: 2 / 3; font-size: .95rem; color: var(--color-muted); text-shadow: 0 2px 6px rgba(0,0,0,0.4); justify-self: end; }

    /* Footer layout: right contact, left credits (desktop); centered on mobile */
    footer {
      background: rgba(0,0,0,0.5);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: nowrap;
      font-size: .9rem;
      color: var(--color-muted);
      margin-top: auto;
      gap: 12px;
    }
    .footer-right, .footer-left { flex: 1; }
    .footer-right { text-align: right; }
    .footer-left  { text-align: left; }
    footer span, footer a { text-shadow: 0 2px 6px rgba(0,0,0,0.4); }

    .contact { font-weight: 700; color: var(--color-text); line-height: 1.6; font-size: 1rem; }
    .contact a { color: var(--color-text); text-decoration: none; font-weight: 800; white-space: nowrap; }

    .small-text { font-size: 0.8rem; color: var(--color-muted); display: block; margin-bottom: 2px; }
    .web-order { font-size: 0.85rem; color: var(--color-text); font-weight: 600; margin-bottom: 2px; }

    @media (max-width: 768px) {
      footer { flex-wrap: wrap; align-items: center; text-align: center; }
      .footer-right, .footer-left { flex: 1 1 100%; text-align: center; }
    }

    .yalda-text p {
    margin: 0 0 16px;    /* ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ùâ€ŒÙ‡Ø§ */
    line-height: 1.95;   /* Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± */
    color: var(--color-text);
    text-shadow: var(--text-shadow);
  }
  .yalda-text p:last-child { margin-bottom: 0; }

  </style>
</head>
<body>
  <div class="hero">ÛŒÙ„Ø¯Ø§ Ù…Ø¨Ø§Ø±Ú©</div>

  <div class="wrap">
    <!-- Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ -->
    <section class="card message" aria-labelledby="msgTitle">
      <h2 id="msgTitle">Ù¾ÛŒØ§Ù… ØªØ¨Ø±ÛŒÚ© ÛŒÙ„Ø¯Ø§</h2>
      <p>Ø´Ù…Ø§ Ù…ÛŒØªÙˆØ§Ù†ÛŒØ¯ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø³ÙˆØ±Ø³ Ú¯Ø°Ø§Ø´ØªÙ‡ Ùˆ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø´Ù†ÙˆÛŒØ¯</p>

      <div class="player">
        <button id="toggleMessageBtn" class="btn" aria-label="Ù¾Ø®Ø´ ÛŒØ§ ØªÙˆÙ‚Ù Ù¾ÛŒØ§Ù…">â–¶ï¸ Ù¾Ø®Ø´ Ù¾ÛŒØ§Ù…</button>

        <div class="timeline" id="timeline" role="slider" aria-label="Ù¾ÛŒØ´Ø±ÙˆÛŒ Ù¾ÛŒØ§Ù…" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
          <div class="progress" id="progress"></div>
        </div>

        <div class="time" id="currentTime">00:00</div>
        <div class="duration" id="totalTime">â€”:â€”</div>
      </div>
    </section>

    <!-- Ù…ÙˆØ²ÛŒÚ© ÛŒÙ„Ø¯Ø§ÛŒÛŒ Ø¯Ù„ ÛŒØ§Ø± -->
    <section class="card music" aria-labelledby="musicTitle">
      <h2 id="musicTitle">Ù…ÙˆØ²ÛŒÚ© ÛŒÙ„Ø¯Ø§ÛŒÛŒ Ø¯Ù„ ÛŒØ§Ø±</h2>
      <p>Ø¨Ø±Ø§ÛŒ Ù¾Ø®Ø´ Ù…ÙˆØ²ÛŒÚ© Ø¨Ø± Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>

      <div class="player">
        <button id="toggleMusicBtn" class="btn" aria-label="Ù¾Ø®Ø´ ÛŒØ§ ØªÙˆÙ‚Ù Ù…ÙˆØ²ÛŒÚ©">â–¶ï¸ Ù¾Ø®Ø´ Ù…ÙˆØ²ÛŒÚ©</button>

        <div class="timeline" id="musicTimeline" role="slider" aria-label="Ù¾ÛŒØ´Ø±ÙˆÛŒ Ù…ÙˆØ²ÛŒÚ©" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
          <div class="progress" id="musicProgress"></div>
        </div>

        <div class="time" id="musicCurrentTime">00:00</div>
        <div class="duration" id="musicTotalTime">â€”:â€”</div>
      </div>
    </section>

    <!-- ÙØ§Ù„ Ø­Ø§ÙØ¸ -->
    <section class="card fortune" id="fortuneCard" aria-labelledby="hafezTitle">
      <h2 id="hafezTitle">ÙØ§Ù„ Ø­Ø§ÙØ¸</h2>
      <p class="helper">Ø¨Ø§ Ù†ÛŒØª ÙØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯</p>
      <button id="nitBtn" class="btn-nit" aria-controls="poem meaning">âœ¨ Ù†ÛŒØª Ú©Ù†ÛŒØ¯ âœ¨</button>

      <div id="poem" class="poem" aria-live="polite"></div>
      <p id="meaning" class="meaning" aria-live="polite">â€”</p>
    </section>

    <!-- Ù…ØªÙ† ØªÙˆØ¶ÛŒØ­ ÛŒÙ„Ø¯Ø§ -->
    <section class="card yalda-text" aria-label="Ø¯Ø±Ø¨Ø§Ø±Ù‡ ÛŒÙ„Ø¯Ø§" dir="rtl">
  <p>
    Ø´Ø¨ ÛŒÙ„Ø¯Ø§ Ú©Ù‡Ù†â€ŒØªØ±ÛŒÙ† Ø¬Ø´Ù†Ù Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø² Ø§ÛŒØ±Ø§Ù† Ø¨Ø§Ø³ØªØ§Ù† Ø§Ø³ØªØ› Ø´Ø¨ÛŒ Ú©Ù‡ Ø¯Ø± Ø¢Ù† Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±ÛŒÙ† ØªØ§Ø±ÛŒÚ©ÛŒ Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…ÛŒâ€ŒØ®ÙˆØ±Ø¯ Ùˆ Ø§Ø² ÙØ±Ø¯Ø§ÛŒ Ø¢Ù†ØŒ Ø±ÙˆØ²Ù‡Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±Ùˆ Ø¨Ù‡ Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ Ù…ÛŒâ€ŒØ±ÙˆÙ†Ø¯. Ø¯Ø± Ø¨Ø§ÙˆØ±Ù‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒØŒ Ø§ÛŒÙ† Ø´Ø¨ Ù†Ù…Ø§Ø¯ Ù†Ø¨Ø±Ø¯ Ù†ÙˆØ± Ùˆ ØªØ§Ø±ÛŒÚ©ÛŒ Ø§Ø³ØªØ› Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø³ÛŒØ§Ù‡ÛŒ Ø¨Ù‡ Ø§ÙˆØ¬ Ù…ÛŒâ€ŒØ±Ø³Ø¯ Ø§Ù…Ø§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø´Ú©Ø³Øª Ù…ÛŒâ€ŒØ®ÙˆØ±Ø¯ Ùˆ Ø®ÙˆØ±Ø´ÛŒØ¯Ù Ù†Ùˆ Ø²Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø±ÛŒØ´Ù‡â€ŒÙ‡Ø§ÛŒ ÛŒÙ„Ø¯Ø§ Ø¨Ù‡ Ø³Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ø±ÛŒØ§ÛŒÛŒ Ùˆ Ø¢ÛŒÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø²Ø±ØªØ´ØªÛŒ Ø¨Ø§Ø²Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯Ø› Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ø±Ø¯Ù… Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø¯Ø§Ø´Øª Ù…ÛŒØªØ±Ø§ØŒ Ø§ÛŒØ²Ø¯Ù Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ Ùˆ Ù¾ÛŒÙ…Ø§Ù†ØŒ Ú¯Ø±Ø¯ Ù‡Ù… Ù…ÛŒâ€ŒØ¢Ù…Ø¯Ù†Ø¯ Ùˆ Ø¨ÛŒØ¯Ø§Ø± Ù…Ø§Ù†Ø¯Ù† Ø±Ø§ Ù†Ø´Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø² Ù‡Ù…Ø±Ø§Ù‡ÛŒ Ø¨Ø§ Ù†ÙˆØ± Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø³ØªÙ†Ø¯.
  </p>

  <p>
    Ø¯Ø± Ø·ÙˆÙ„ ØªØ§Ø±ÛŒØ®ØŒ ÛŒÙ„Ø¯Ø§ Ø¨Ù‡ Ø¬Ø´Ù†Ù Ø§Ù…ÛŒØ¯ØŒ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ùˆ Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯. Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ† Ø´Ø¨ Ø¯ÙˆØ± Ù‡Ù… Ø¬Ù…Ø¹ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ØŒ Ù‚ØµÙ‡â€ŒÙ‡Ø§ÛŒ Ú©Ù‡Ù† Ù…ÛŒâ€ŒØ´Ù†ÙˆÙ†Ø¯ØŒ Ø¯ÛŒÙˆØ§Ù† Ø­Ø§ÙØ¸ Ù…ÛŒâ€ŒÚ¯Ø´Ø§ÛŒÙ†Ø¯ Ùˆ Ø¨Ø§ Ø®ÙˆØ±Ø¯Ù† Ù…ÛŒÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±Ø®â€ŒÙØ§Ù… Ù…Ø§Ù†Ù†Ø¯ Ø§Ù†Ø§Ø± Ùˆ Ù‡Ù†Ø¯ÙˆØ§Ù†Ù‡ØŒ Ú¯Ø±Ù…ÛŒ Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ø¯Ø¹ÙˆØª Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯. Ø§ÛŒÙ† Ø¢ÛŒÛŒÙ†â€ŒÙ‡Ø§ ØªÙ†Ù‡Ø§ Ø±Ø³ÙˆÙ… Ø³Ø§Ø¯Ù‡ Ù†ÛŒØ³ØªÙ†Ø¯Ø› Ø¨Ù„Ú©Ù‡ Ø¨Ø§Ø²ØªØ§Ø¨ÛŒ Ø§Ø² ÙÙ„Ø³ÙÙ‡â€ŒØ§ÛŒ Ø¹Ù…ÛŒÙ‚â€ŒØ§Ù†Ø¯: Ø§ÛŒÙ†Ú©Ù‡ Ø­ØªÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±ÛŒÙ† ØªØ§Ø±ÛŒÚ©ÛŒâ€ŒÙ‡Ø§ Ù†ÛŒØ² Ú¯Ø°Ø±Ø§ Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø§Ø²Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
  </p>

  <p>
    Ø§Ù…Ø±ÙˆØ² ÛŒÙ„Ø¯Ø§ Ù†Ù‡â€ŒÙÙ‚Ø· Ø¯Ø± Ø§ÛŒØ±Ø§Ù†ØŒ Ø¨Ù„Ú©Ù‡ Ø¯Ø± Ù…ÛŒØ§Ù† Ø¬ÙˆØ§Ù…Ø¹ Ø§ÛŒØ±Ø§Ù†ÛŒâ€ŒØªØ¨Ø§Ø± Ø¯Ø± Ø³Ø±Ø§Ø³Ø± Ø¬Ù‡Ø§Ù† Ø¬Ø´Ù† Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ù…ÛŒØ±Ø§Ø« Ù†Ø§Ù…Ù„Ù…ÙˆØ³ ÛŒÙˆÙ†Ø³Ú©Ùˆ Ù†ÛŒØ² Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§ÛŒÙ† Ø´Ø¨ØŒ Ù¾Ù„ÛŒ Ø§Ø³Øª Ù…ÛŒØ§Ù† Ø§Ø³Ø·ÙˆØ±Ù‡ Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡Ø› ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§ÛŒÙ†Ú©Ù‡ Ø§Ù†Ø³Ø§Ù† Ø¨Ø§ Ú¯Ø±Ø¯Ù‡Ù…Ø§ÛŒÛŒØŒ Ø±ÙˆØ§ÛŒØª Ùˆ Ù…Ù‡Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒÚ©ÛŒ Ø±Ø§ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ú©Ù†Ø¯ Ùˆ Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ Ø±Ø§ Ø¨Ù„Ù†Ø¯ØªØ±.
  </p>

  <p><strong>ÛŒÙ„Ø¯Ø§ØªÙˆÙ† Ù…Ø¨Ø§Ø±Ú©</strong></p>
</section>

  </div>

  <!-- ÙÙˆØªØ±: Ø±Ø§Ø³Øª Ø³ÙØ§Ø±Ø´ Ù¾Ú©ØŒ Ú†Ù¾ Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ú©Ù¾ÛŒâ€ŒØ±Ø§ÛŒØª -->
  <footer>
    <div class="footer-right">
      <span class="contact">
        Ø¬Ù‡Øª Ø³ÙØ§Ø±Ø´ Ø³Ø§ÛŒØª Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ Ø²ÛŒØ± ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯<br>
        <a href="tel:09106661905">ğŸ“ 0910&nbsp;666&nbsp;1905</a>
      </span>
    </div>
    <div class="footer-left">
      <span class="small-text">Designed by Aryan Alavi</span>
      <span class="web-order">Ø³ÙØ§Ø±Ø´ ØµÙØ­Ø§Øª ÙˆØ¨: <a href="tel:09106661905">09106661905</a></span>
      <span class="small-text">Copyright Â© 1404</span>
    </div>
  </footer>

  <!-- Audio elements -->
  <audio id="messageAudio" preload="auto" playsinline src="assets/audio/message.mp3"></audio>
  <audio id="introAudio" preload="auto" playsinline src="assets/audio/intro.mp3" loop></audio>

  <script>
    const THEME = { hafezJsonUrl: 'assets/data/hafez.json', BG_VOLUME: 0.35 };

    // Elements
    const introAudio       = document.getElementById('introAudio');
    const messageAudio     = document.getElementById('messageAudio');
    const toggleMessageBtn = document.getElementById('toggleMessageBtn');
    const toggleMusicBtn   = document.getElementById('toggleMusicBtn');

    const timeline       = document.getElementById('timeline');
    const progress       = document.getElementById('progress');
    const currentTimeEl  = document.getElementById('currentTime');
    const totalTimeEl    = document.getElementById('totalTime');

    const musicTimeline    = document.getElementById('musicTimeline');
    const musicProgress    = document.getElementById('musicProgress');
    const musicCurrentTime = document.getElementById('musicCurrentTime');
    const musicTotalTime   = document.getElementById('musicTotalTime');

    const fortuneCard = document.getElementById('fortuneCard');
    const nitBtn      = document.getElementById('nitBtn');
    const poemEl      = document.getElementById('poem');
    const meaningEl   = document.getElementById('meaning');

    let hafezCache = null;

    // Time formatting
    function formatTime(sec) {
      if (!isFinite(sec)) return 'â€”:â€”';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    /* ---------------- Message player UI ---------------- */
    let rafId = null;
    function updateMessageUI() {
      if (rafId) return;
      rafId = requestAnimationFrame(() => {
        const cur = messageAudio.currentTime || 0;
        const dur = messageAudio.duration || 0;
        currentTimeEl.textContent = formatTime(cur);
        totalTimeEl.textContent = formatTime(dur);
        const pct = dur ? (cur / dur) * 100 : 0;
        progress.style.width = `${pct}%`;
        timeline.setAttribute('aria-valuenow', Math.round(pct));
        rafId = null;
      });
    }

    function seekMessageFromClientX(clientX) {
      const rect = timeline.getBoundingClientRect();
      const x = (clientX - rect.left) / rect.width;
      const dur = messageAudio.duration || 0;
      if (dur) messageAudio.currentTime = Math.min(Math.max(x, 0), 1) * dur;
    }

    timeline.addEventListener('click', (e) => seekMessageFromClientX(e.clientX));
    timeline.addEventListener('keydown', (e) => {
      const dur = messageAudio.duration || 0;
      if (!dur) return;
      const step = dur / 20; // 5%
      if (e.key === 'ArrowRight') messageAudio.currentTime = Math.min(messageAudio.currentTime + step, dur);
      if (e.key === 'ArrowLeft')  messageAudio.currentTime = Math.max(messageAudio.currentTime - step, 0);
    });

    messageAudio.addEventListener('loadedmetadata', updateMessageUI);
    messageAudio.addEventListener('timeupdate', updateMessageUI);
    messageAudio.addEventListener('ended', () => {
      toggleMessageBtn.textContent = 'â–¶ï¸ Ù¾Ø®Ø´ Ù¾ÛŒØ§Ù…';
    });

    /* ---------------- Music player UI ---------------- */
    function updateMusicUI() {
      const cur = introAudio.currentTime || 0;
      const dur = introAudio.duration || 0;
      musicCurrentTime.textContent = formatTime(cur);
      musicTotalTime.textContent = formatTime(dur);
      const pct = dur ? (cur / dur) * 100 : 0;
      musicProgress.style.width = `${pct}%`;
      musicTimeline.setAttribute('aria-valuenow', Math.round(pct));
    }
    introAudio.addEventListener('loadedmetadata', updateMusicUI);
    introAudio.addEventListener('timeupdate', updateMusicUI);

    function seekMusicFromClientX(clientX) {
      const rect = musicTimeline.getBoundingClientRect();
      const x = (clientX - rect.left) / rect.width;
      const dur = introAudio.duration || 0;
      if (dur) introAudio.currentTime = Math.min(Math.max(x, 0), 1) * dur;
    }
    musicTimeline.addEventListener('click', (e) => seekMusicFromClientX(e.clientX));
    musicTimeline.addEventListener('keydown', (e) => {
      const dur = introAudio.duration || 0;
      if (!dur) return;
      const step = dur / 20; // 5%
      if (e.key === 'ArrowRight') introAudio.currentTime = Math.min(introAudio.currentTime + step, dur);
      if (e.key === 'ArrowLeft')  introAudio.currentTime = Math.max(introAudio.currentTime - step, 0);
    });

    /* ---------------- Mutual exclusivity logic ---------------- */
    async function playMessage() {
      if (!introAudio.paused) {
        pauseMusic();
      }
      try {
        await messageAudio.play();
        toggleMessageBtn.textContent = 'â¸ï¸ ØªÙˆÙ‚Ù Ù¾ÛŒØ§Ù…';
      } catch {}
    }
    function pauseMessage() {
      messageAudio.pause();
      toggleMessageBtn.textContent = 'â–¶ï¸ Ù¾Ø®Ø´ Ù¾ÛŒØ§Ù…';
    }

    async function playMusic() {
      if (!messageAudio.paused) {
        pauseMessage();
      }
      introAudio.volume = THEME.BG_VOLUME;
      try {
        await introAudio.play();
        toggleMusicBtn.textContent = 'â¸ï¸ ØªÙˆÙ‚Ù Ù…ÙˆØ²ÛŒÚ©';
      } catch {}
    }
    function pauseMusic() {
      introAudio.pause();
      toggleMusicBtn.textContent = 'â–¶ï¸ Ù¾Ø®Ø´ Ù…ÙˆØ²ÛŒÚ©';
    }

    // Buttons
    toggleMessageBtn.addEventListener('click', () => {
      if (messageAudio.paused) playMessage();
      else pauseMessage();
    });

    toggleMusicBtn.addEventListener('click', () => {
      if (introAudio.paused) playMusic();
      else pauseMusic();
    });

    /* ---------------- Fortune: auto-play music on open ---------------- */
    async function loadHafez() {
      if (hafezCache) return hafezCache;
      const res = await fetch(THEME.hafezJsonUrl, { cache: 'no-store' });
      const data = await res.json();
      hafezCache = Array.isArray(data) ? data : [];
      return hafezCache;
    }

    function splitVerse(verse) {
      if (!verse || typeof verse !== 'string') return ['â€”', ''];
      const normalized = verse.replace(/\s+/g, ' ').trim();
      const separators = [' â€” ', 'â€”', ' â€¢ ', ' | '];
      for (const sep of separators) {
        if (normalized.includes(sep)) {
          const parts = normalized.split(sep);
          if (parts.length >= 2) return [parts[0].trim(), parts[1].trim()];
        }
      }
      const spaceParts = verse.split(/\s{2,}/);
      if (spaceParts.length >= 2) return [spaceParts[0].trim(), spaceParts[1].trim()];
      const mid = Math.floor(normalized.length / 2);
      let splitIdx = normalized.lastIndexOf(' ', mid);
      if (splitIdx < 0 || splitIdx > normalized.length - 5) splitIdx = normalized.indexOf(' ', mid);
      if (splitIdx > 0) {
        return [normalized.slice(0, splitIdx).trim(), normalized.slice(splitIdx + 1).trim()];
      }
      return [normalized, ''];
    }

    async function drawFortuneFromJSON() {
      try {
        const data = await loadHafez();
        if (!Array.isArray(data) || data.length === 0) {
          poemEl.innerHTML = '';
          meaningEl.textContent = 'Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
          return;
        }
        const pick = data[Math.floor(Math.random() * data.length)];
        const [top, bottom] = splitVerse(pick.verse || '');
        poemEl.innerHTML = `
          <div class="misra misra-top">${top || 'â€”'}</div>
          <div class="misra misra-bottom">${bottom || ''}</div>
        `;
        meaningEl.textContent = pick.meaning || '';
      } catch {
        poemEl.innerHTML = '';
        meaningEl.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§Ù„.';
      }
    }

    nitBtn.addEventListener('click', async () => {
      fortuneCard.classList.add('expanded');
      await drawFortuneFromJSON();
      const helper = fortuneCard.querySelector('.helper');
      if (helper) helper.remove();
      nitBtn.remove();

      // Auto-play music when fortune opens, and stop message if playing
      if (!introAudio.paused) {
        // if already playing music, keep it; else start
        toggleMusicBtn.textContent = 'â¸ï¸ ØªÙˆÙ‚Ù Ù…ÙˆØ²ÛŒÚ©';
      } else {
        playMusic();
      }
    }, { once: true });

    // Prevent context menu on audio/buttons
    document.addEventListener('contextmenu', (e) => {
      const tag = (e.target.tagName || '').toLowerCase();
      if (['audio', 'button'].includes(tag)) e.preventDefault();
    });
  </script>
</body>

</html>
